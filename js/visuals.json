// js/visuals.js
export const BRAND = {
  shale:  "#191919",
  mist:   "#114036",
  teal:   "#16AF8E",
  citrine:"#F9B73F",
  gypsum: "#F9F3D9",
  palette: ["#16AF8E","#F9B73F","#114036","#F9F3D9","#191919"]
};

/**
 * VISUALS registry:
 *  - id, title, lib, data (CSV URL), build(data) => library options/spec
 *  - tags are optional (used for badges, filtering later)
 */
export const VISUALS = [
  {
    id: "spendByCategory",
    title: "Spend by Category — Q3",
    lib: "echarts",
    data: "data/spend_by_cat.csv",
    tags: ["spend","category","bar/treemap"],
    build: (rows) => {
      // rows: [{Category, SpendAED}]
      const cats = rows.map(r => r.Category);
      const vals = rows.map(r => +r.SpendAED);
      return {
        backgroundColor: BRAND.shale,
        color: BRAND.palette,
        tooltip: { trigger: 'axis' },
        grid: { left: 60, right: 20, top: 40, bottom: 50 },
        xAxis: { type: 'category', data: cats, axisLabel: { color: BRAND.gypsum } },
        yAxis: { type: 'value', axisLabel: { color: BRAND.gypsum }, name: 'AED' },
        dataZoom: [{ type:'inside' }, { type:'slider' }],
        series: [{ type: 'bar', data: vals, barMaxWidth: 36, emphasis: { focus: 'series' } }]
      };
    }
  },
  {
    id: "supplierRiskHeatmap",
    title: "Supplier Risk Heatmap",
    lib: "echarts",
    data: "data/supplier_risk.csv",
    tags: ["risk","supplier","heatmap"],
    build: (rows) => {
      // rows: [{Supplier, Category, Risk}] => build axes + [xIndex,yIndex,value]
      const suppliers = [...new Set(rows.map(r => r.Supplier))];
      const categories = [...new Set(rows.map(r => r.Category))];
      const matrix = rows.map(r => [
        categories.indexOf(r.Category),
        suppliers.indexOf(r.Supplier),
        +r.Risk
      ]);
      return {
        tooltip: { position: 'top' },
        grid: { left: 100, right: 20, top: 40, bottom: 60 },
        xAxis: { type: 'category', data: categories, splitArea: { show: true }, axisLabel:{ color: BRAND.gypsum }},
        yAxis: { type: 'category', data: suppliers, splitArea: { show: true }, axisLabel:{ color: BRAND.gypsum }},
        visualMap: { min: 0, max: 100, calculable: true, orient: 'horizontal', left: 'center', bottom: 10,
          inRange: { color: [ '#114036', '#16AF8E', '#F9B73F' ] } },
        series: [{
          name: 'Risk',
          type: 'heatmap',
          data: matrix,
          label: { show: true, color: '#fff' },
          emphasis: { itemStyle: { shadowBlur: 10, shadowColor: 'rgba(0,0,0,0.5)' } }
        }]
      };
    }
  },
  {
    id: "contractExpiryTimeline",
    title: "Contracts — Days to Expiry",
    lib: "echarts",
    data: "data/contracts_timeline.csv",
    tags: ["contracts","expiry","bar"],
    build: (rows) => {
      // rows: [{Contract, DaysToExpiry}]
      const names = rows.map(r => r.Contract);
      const days = rows.map(r => +r.DaysToExpiry);
      return {
        backgroundColor: BRAND.shale,
        color: [BRAND.citrine],
        tooltip: { trigger: 'axis' },
        grid: { left: 140, right: 24, top: 20, bottom: 40 },
        xAxis: { type: 'value', name: 'Days', axisLabel:{ color: BRAND.gypsum }},
        yAxis: { type: 'category', data: names, axisLabel:{ color: BRAND.gypsum }},
        series: [{ type: 'bar', data: days, barMaxWidth: 18 }]
      };
    }
  },
  // Plotly example (lazy-loaded in Full View only)
  {
    id: "supplierPerformanceScatter",
    title: "Supplier Performance — Spend vs On-Time %",
    lib: "plotly",
    data: null, // we’ll inline dummy data in the builder
    tags: ["suppliers","scatter","plotly","lasso"],
    build: () => {
      const spend = [320, 180, 520, 260, 410, 120, 680, 295];
      const ontime = [96, 88, 91, 84, 93, 90, 86, 97];
      const names  = ["Alpha","BlueWave","Desert","Orion","Kite","Metro","Nova","Zena"];
      return {
        data: [{
          x: spend, y: ontime, text: names, mode: 'markers',
          marker: { size: 12, color: BRAND.teal }, type: 'scatter'
        }],
        layout: {
          paper_bgcolor: BRAND.shale, plot_bgcolor: BRAND.shale,
          font: { color: BRAND.gypsum },
          xaxis: { title: 'Spend (AED x1k)' }, yaxis: { title: 'On-Time %', range: [80,100] },
          dragmode: 'lasso', showlegend: false, margin: { t: 20, r: 10, b: 40, l: 50 }
        },
        config: { responsive: true, displaylogo: false, modeBarButtonsToRemove: ['toImage'] }
      };
    }
  }
];
